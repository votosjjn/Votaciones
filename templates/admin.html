<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin - Asistencia</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .admin-row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .student-list{max-height:340px;overflow:auto;margin-top:12px}
    .student-item{display:flex;gap:12px;align-items:center;padding:8px;border-radius:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
    .student-item .name{flex:1}
    .upload-box{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:14px}
    .search{width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.03);color:#fff}
  </style>
</head>
<body>
  {% if not session.get('admin') %}
  <div class="container">
    <section class="card center">
      <h2>Acceso Administrador</h2>
      <form method="POST">
        <label>Contraseña</label>
        <input type="password" name="password" placeholder="Contraseña">
        <div class="actions" style="justify-content:center;margin-top:12px">
          <button class="btn-glow" type="submit">Entrar</button>
          <a class="btn-outline" href="/">Volver</a>
        </div>
      </form>
      {% if error %}
        <p class="msg" style="color:#ff8a8a">{{ error }}</p>
      {% endif %}
    </section>
  </div>
  {% else %}
  <div class="container">
    <section class="card">
      <h2>Administración</h2>
      <p class="welcome-text">Cargar archivo con estudiantes (.xlsx o .csv). Columnas: Documento, Nombre, Curso, Nivel (opcional)</p>

      <div class="upload-box">
        <form id="uploadForm" method="post" action="/admin/upload_students" enctype="multipart/form-data">
          <input type="file" name="file" accept=".xlsx,.xls,.csv" required>
          <button class="btn-glow" type="submit">Subir y procesar</button>
        </form>

        <form method="post" action="/admin/reset/primaria" style="display:inline-block;margin-left:8px">
          <button class="btn-outline" onclick="return confirm('Resetear votos Primaria?')">Reset Votos Primaria</button>
        </form>
        <form method="post" action="/admin/reset/secundaria" style="display:inline-block;margin-left:8px">
          <button class="btn-outline" onclick="return confirm('Resetear votos Secundaria?')">Reset Votos Secundaria</button>
        </form>
      </div>

      <div style="margin-top:14px" class="admin-row">
        <div>
          <h3>Primaria ({{ total_prim }})</h3>
          <a class="btn-outline" href="/data/export/primaria">Exportar CSV</a>
        </div>
        <div>
          <h3>Secundaria ({{ total_sec }})</h3>
          <a class="btn-outline" href="/data/export/secundaria">Exportar CSV</a>
        </div>
      </div>

      <div style="margin-top:18px">
        <label>Buscar en Primaria</label>
        <input id="searchPrim" class="search" placeholder="Documento o nombre...">
        <div id="listPrim" class="student-list">
          {% for doc, st in estudiantes_prim.items() %}
          <div class="student-item" data-doc="{{ doc }}" data-level="primaria">
            <div class="name"><b>{{ st.nombre }}</b><br><small>{{ doc }} — {{ st.curso }}</small></div>
            <div><button class="btn-outline present-btn" data-doc="{{ doc }}" data-level="primaria">{{ 'Presente' if st.presente else 'Ausente' }}</button></div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div style="margin-top:18px">
        <label>Buscar en Secundaria</label>
        <input id="searchSec" class="search" placeholder="Documento o nombre...">
        <div id="listSec" class="student-list">
          {% for doc, st in estudiantes_sec.items() %}
          <div class="student-item" data-doc="{{ doc }}" data-level="secundaria">
            <div class="name"><b>{{ st.nombre }}</b><br><small>{{ doc }} — {{ st.curso }}</small></div>
            <div><button class="btn-outline present-btn" data-doc="{{ doc }}" data-level="secundaria">{{ 'Presente' if st.presente else 'Ausente' }}</button></div>
          </div>
          {% endfor %}
        </div>
      </div>

      <div style="margin-top:18px">
        <a class="btn-glow" href="/primaria/results">Ver resultados Primaria</a>
        <a class="btn-glow" href="/secundaria/results">Ver resultados Secundaria</a>
        <a class="btn-outline" href="/admin/logout">Cerrar sesión</a>
        <a class="btn-outline" href="/">Volver al menú</a>
      </div>
    </section>
  </div>

  <!-- admin scripts -->
  <script>
    async function togglePresent(doc, level, btn){
      try {
        const res = await fetch('/admin/toggle_present', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({doc: doc, level: level})
        });
        const j = await res.json();
        if(j.ok){
          btn.textContent = j.presente ? 'Presente' : 'Ausente';
        } else {
          alert(j.msg || 'Error');
        }
      } catch(e){ alert('Error de red'); }
    }

    document.querySelectorAll('.present-btn').forEach(b=>{
      b.addEventListener('click', (ev)=>{
        ev.preventDefault();
        const doc = b.dataset.doc;
        const level = b.dataset.level;
        togglePresent(doc, level, b);
      });
    });

    // simple search
    function filterList(inputId, listId){
      const q = document.getElementById(inputId);
      const list = document.getElementById(listId);
      q.addEventListener('input', ()=> {
        const v = q.value.toLowerCase().trim();
        list.querySelectorAll('.student-item').forEach(it=>{
          const doc = it.dataset.doc.toLowerCase();
          const name = it.querySelector('.name').textContent.toLowerCase();
          it.style.display = (doc.includes(v) || name.includes(v)) ? '' : 'none';
        });
      });
    }
    filterList('searchPrim','listPrim');
    filterList('searchSec','listSec');
  </script>
  {% endif %}
</body>
</html>
